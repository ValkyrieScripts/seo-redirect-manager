# Dynamic redirect server
# This handles all redirect domains

server {
    listen 80;
    server_name ~^(?<domain>.+)$;

    # Skip for localhost/admin panel
    if ($host = "localhost") {
        return 444;
    }

    # Redirect handler
    location / {
        content_by_lua_block {
            local redirects = require "redirects"
            redirects.handle()
        }
    }

    # Cache clear endpoint (protected, call from backend only)
    location /internal/clear-cache {
        allow 127.0.0.1;
        allow 172.16.0.0/12;  # Docker network
        deny all;

        content_by_lua_block {
            local redirects = require "redirects"
            redirects.clear_cache()
        }
    }
}

# Admin panel proxy (if needed)
# server {
#     listen 80;
#     server_name admin.yourdomain.com;
#
#     location / {
#         proxy_pass http://frontend:80;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#     }
#
#     location /api {
#         proxy_pass http://backend:3001;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#     }
# }
